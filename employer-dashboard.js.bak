// Employer Dashboard Logic
let currentUser = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Check authentication
    const userStr = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
    if (!userStr) {
        window.location.href = 'index.html';
        return;
    }

    currentUser = JSON.parse(userStr);
    if (currentUser.type !== 'employer') {
        window.location.href = 'index.html';
        return;
    }

    initializeDashboard();
});

function initializeDashboard() {
    // Set user info
    document.getElementById('userBalance').textContent = formatCurrency(currentUser.balance || 0);
    document.getElementById('userInitials').textContent = currentUser.name.charAt(0).toUpperCase();

    // Load dashboard data
    loadDashboardStats();
    loadRecentApplicants();
}

// Section Navigation
function showSection(sectionName) {
    // Update nav items
    const allNavItems = document.querySelectorAll('.nav-item');
    allNavItems.forEach(item => item.classList.remove('active'));

    // Find and activate the clicked nav item
    allNavItems.forEach(item => {
        if (item.getAttribute('onclick')?.includes(`'${sectionName}'`)) {
            item.classList.add('active');
        }
    });

    // Update sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(`section-${sectionName}`).classList.add('active');

    // Update page title
    const titles = {
        dashboard: 'Bosh sahifa',
        'post-job': 'Ish e\'lon qilish',
        'my-jobs': 'Mening ishlarim',
        applicants: 'Murojaatlar',
        contracts: 'Shartnomalar',
        payments: 'To\'lovlar',
        history: 'Tarix'
    };
    document.getElementById('pageTitle').textContent = titles[sectionName];

    // Load section data
    loadSectionData(sectionName);
}

function loadSectionData(sectionName) {
    switch (sectionName) {
        case 'my-jobs':
            loadMyJobs();
            break;
        case 'applicants':
            loadAllApplicants();
            break;
        case 'contracts':
            loadContracts();
            break;
        case 'payments':
            loadPayments();
            break;
        case 'history':
            loadHistory();
            break;
    }
}

// Dashboard Stats
function loadDashboardStats() {
    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const myJobs = jobs.filter(j => j.employerId === currentUser.id);

    const applications = JSON.parse(localStorage.getItem(STORAGE_KEYS.APPLICATIONS) || '[]');
    const myApplications = applications.filter(app => {
        const job = jobs.find(j => j.id === app.jobId);
        return job && job.employerId === currentUser.id;
    });

    document.getElementById('totalJobs').textContent = myJobs.length;
    document.getElementById('activeJobs').textContent = myJobs.filter(j => j.status === 'active').length;
    document.getElementById('completedJobs').textContent = myJobs.filter(j => j.status === 'completed').length;
    document.getElementById('totalApplicants').textContent = myApplications.length;
}

// Recent Applicants
function loadRecentApplicants() {
    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const applications = JSON.parse(localStorage.getItem(STORAGE_KEYS.APPLICATIONS) || '[]');
    const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');

    const myJobs = jobs.filter(j => j.employerId === currentUser.id);
    const myJobIds = myJobs.map(j => j.id);
    const myApplications = applications
        .filter(app => myJobIds.includes(app.jobId) && app.status === 'pending')
        .slice(0, 5);

    const container = document.getElementById('recentApplicants');

    if (myApplications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <div class="empty-state-text">Hozircha yangi murojaatlar yo'q</div>
            </div>
        `;
        return;
    }

    container.innerHTML = myApplications.map(app => {
        const job = jobs.find(j => j.id === app.jobId);
        const worker = users.find(u => u.id === app.workerId);

        return `
            <div class="application-card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">
                            ${worker?.name || 'Noma\'lum'}
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">
                            ${job?.title} uchun murojaat
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">
                            ${formatDate(app.appliedAt)}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-primary" onclick="acceptApplicant('${app.id}')">
                        Qabul qilish
                    </button>
                    <button class="btn-danger" onclick="rejectApplicant('${app.id}')">
                        Rad etish
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Post Job
document.getElementById('postJobForm')?.addEventListener('submit', (e) => {
    e.preventDefault();

    const title = document.getElementById('jobTitle').value;
    const description = document.getElementById('jobDescription').value;
    const category = document.getElementById('jobCategory').value;
    const salary = parseInt(document.getElementById('jobSalary').value);
    const location = document.getElementById('jobLocation').value;
    const duration = document.getElementById('jobDuration').value;
    const requirementsText = document.getElementById('jobRequirements').value;

    const requirements = requirementsText
        ? requirementsText.split('\n').filter(r => r.trim())
        : [];

    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');

    const newJob = {
        id: Date.now().toString(),
        employerId: currentUser.id,
        employerName: currentUser.name,
        title,
        description,
        category,
        salary,
        location,
        lat: 41.2995 + (Math.random() - 0.5) * 0.1, // Random location near Tashkent
        lon: 69.2401 + (Math.random() - 0.5) * 0.1,
        duration,
        requirements,
        status: 'active',
        createdAt: new Date().toISOString()
    };

    jobs.push(newJob);
    localStorage.setItem(STORAGE_KEYS.JOBS, JSON.stringify(jobs));

    alert('Ish muvaffaqiyatli e\'lon qilindi!');
    e.target.reset();
    loadDashboardStats();
});

// My Jobs
function loadMyJobs() {
    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const myJobs = jobs.filter(j => j.employerId === currentUser.id);

    const container = document.getElementById('myJobsList');

    if (myJobs.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üíº</div>
                <div class="empty-state-text">Siz hali ish e'lon qilmadingiz</div>
            </div>
        `;
        return;
    }

    container.innerHTML = myJobs.map(job => `
        <div class="job-card">
            <div class="job-header">
                <div>
                    <div class="job-title">${job.title}</div>
                    <span class="job-category">${job.category}</span>
                </div>
                <span class="status-badge status-${job.status}">
                    ${job.status === 'active' ? 'Faol' : 'Tugallangan'}
                </span>
            </div>
            <div class="job-meta">
                <span class="job-meta-item">üìç ${job.location}</span>
                <span class="job-meta-item">‚è±Ô∏è ${job.duration}</span>
                <span class="job-meta-item">üí∞ ${formatCurrency(job.salary)}</span>
            </div>
            <div class="job-description">${job.description}</div>
            <div style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;">
                E'lon qilingan: ${formatDate(job.createdAt)}
            </div>
            ${job.status === 'active' ? `
                <div class="job-actions" style="margin-top: 1rem;">
                    <button class="btn-secondary" onclick="viewJobApplicants('${job.id}')">
                        Murojaatlarni ko'rish
                    </button>
                    <button class="btn-danger" onclick="deleteJob('${job.id}')">
                        O'chirish
                    </button>
                </div>
            ` : ''}
        </div>
    `).join('');
}

function deleteJob(jobId) {
    if (!confirm('Ishni o\'chirishni xohlaysizmi?')) return;

    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const filteredJobs = jobs.filter(j => j.id !== jobId);
    localStorage.setItem(STORAGE_KEYS.JOBS, JSON.stringify(filteredJobs));

    alert('Ish o\'chirildi!');
    loadMyJobs();
    loadDashboardStats();
}

function viewJobApplicants(jobId) {
    showSection('applicants');
}

// All Applicants
function loadAllApplicants() {
    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const applications = JSON.parse(localStorage.getItem(STORAGE_KEYS.APPLICATIONS) || '[]');
    const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');

    const myJobs = jobs.filter(j => j.employerId === currentUser.id);
    const myJobIds = myJobs.map(j => j.id);
    const myApplications = applications.filter(app => myJobIds.includes(app.jobId));

    const container = document.getElementById('allApplicantsList');

    if (myApplications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <div class="empty-state-text">Hozircha murojaatlar yo'q</div>
            </div>
        `;
        return;
    }

    container.innerHTML = myApplications.map(app => {
        const job = jobs.find(j => j.id === app.jobId);
        const worker = users.find(u => u.id === app.workerId);

        return `
            <div class="application-card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">
                            ${worker?.name || 'Noma\'lum'}
                        </div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                            üìã ${job?.title}
                        </div>
                        ${worker?.profile ? `
                            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">
                                üíº ${worker.profile.jobType || 'Ko\'rsatilmagan'}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">
                                üìç ${worker.profile.region || 'Ko\'rsatilmagan'}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.875rem;">
                                ‚≠ê Tajriba: ${worker.profile.experience || 0} yil
                            </div>
                        ` : ''}
                        <div style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">
                            Yuborilgan: ${formatDate(app.appliedAt)}
                        </div>
                    </div>
                    <span class="status-badge status-${app.status}">
                        ${app.status === 'pending' ? 'Kutilmoqda' :
                app.status === 'accepted' ? 'Qabul qilindi' : 'Rad etildi'}
                    </span>
                </div>
                ${app.status === 'pending' ? `
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn-primary" onclick="acceptApplicant('${app.id}')">
                            Qabul qilish
                        </button>
                        <button class="btn-danger" onclick="rejectApplicant('${app.id}')">
                            Rad etish
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function acceptApplicant(applicationId) {
    if (!confirm('Bu ishchini qabul qilishni xohlaysizmi? Shartnoma yaratiladi.')) return;

    const applications = JSON.parse(localStorage.getItem(STORAGE_KEYS.APPLICATIONS) || '[]');
    const appIndex = applications.findIndex(a => a.id === applicationId);

    if (appIndex === -1) return;

    applications[appIndex].status = 'accepted';
    localStorage.setItem(STORAGE_KEYS.APPLICATIONS, JSON.stringify(applications));

    // Create contract
    const app = applications[appIndex];
    const jobs = JSON.parse(localStorage.getItem(STORAGE_KEYS.JOBS) || '[]');
    const job = jobs.find(j => j.id === app.jobId);

    if (job) {
        const contracts = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTS) || '[]');
        const newContract = {
            id: Date.now().toString(),
            jobId: job.id,
            jobTitle: job.title,
            employerId: currentUser.id,
            employerName: currentUser.name,
            workerId: app.workerId,
            workerName: app.workerName,
            amount: job.salary,
            status: 'active',
            startDate: new Date().toISOString(),
            createdAt: new Date().toISOString()
        };

        contracts.push(newContract);
        localStorage.setItem(STORAGE_KEYS.CONTRACTS, JSON.stringify(contracts));
    }

    alert('Ishchi qabul qilindi va shartnoma yaratildi!');
    loadAllApplicants();
    loadDashboardStats();
}

function rejectApplicant(applicationId) {
    if (!confirm('Bu murojaatni rad etishni xohlaysizmi?')) return;

    const applications = JSON.parse(localStorage.getItem(STORAGE_KEYS.APPLICATIONS) || '[]');
    const appIndex = applications.findIndex(a => a.id === applicationId);

    if (appIndex !== -1) {
        applications[appIndex].status = 'rejected';
        localStorage.setItem(STORAGE_KEYS.APPLICATIONS, JSON.stringify(applications));

        alert('Murojaat rad etildi!');
        loadAllApplicants();
    }
}

// Contracts
function loadContracts() {
    const contracts = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTS) || '[]');
    const myContracts = contracts.filter(c => c.employerId === currentUser.id);

    const container = document.getElementById('contractsList');

    if (myContracts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <div class="empty-state-text">Sizda faol shartnomalar yo'q</div>
            </div>
        `;
        return;
    }

    container.innerHTML = myContracts.map(contract => `
        <div class="contract-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">
                        ${contract.jobTitle}
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">
                        üë§ Ishchi: ${contract.workerName}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        Boshlanish: ${formatDate(contract.startDate)}
                    </div>
                </div>
                <span class="status-badge status-${contract.status}">
                    ${contract.status === 'active' ? 'Faol' : 'Tugallangan'}
                </span>
            </div>
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem;">
                üí∞ ${formatCurrency(contract.amount)}
            </div>
            ${contract.status === 'completed' && !contract.paid ? `
                <button class="btn-primary" onclick="approvePayment('${contract.id}')">
                    To'lovni tasdiqlash
                </button>
            ` : contract.paid ? `
                <div style="color: var(--success);">‚úÖ To'lov amalga oshirildi</div>
            ` : `
                <div style="color: var(--text-muted);">Ish jarayonida...</div>
            `}
        </div>
    `).join('');
}

function approvePayment(contractId) {
    if (!confirm('To\'lovni tasdiqlaysizmi? Pul ishchiga o\'tkaziladi.')) return;

    const contracts = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTS) || '[]');
    const contractIndex = contracts.findIndex(c => c.id === contractId);

    if (contractIndex === -1) return;

    const contract = contracts[contractIndex];
    contracts[contractIndex].paid = true;
    contracts[contractIndex].paidDate = new Date().toISOString();
    localStorage.setItem(STORAGE_KEYS.CONTRACTS, JSON.stringify(contracts));

    // Create transaction
    const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
    const newTransaction = {
        id: Date.now().toString(),
        contractId: contract.id,
        senderId: currentUser.id,
        senderName: currentUser.name,
        receiverId: contract.workerId,
        receiverName: contract.workerName,
        amount: contract.amount * 0.95, // 5% commission
        commission: contract.amount * 0.05,
        status: 'completed',
        date: new Date().toISOString()
    };

    transactions.push(newTransaction);
    localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));

    // Update worker balance
    const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS) || '[]');
    const workerIndex = users.findIndex(u => u.id === contract.workerId);
    if (workerIndex !== -1) {
        users[workerIndex].balance = (users[workerIndex].balance || 0) + newTransaction.amount;
        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
    }

    alert('To\'lov muvaffaqiyatli amalga oshirildi!');
    loadContracts();
}

// Payments
function loadPayments() {
    const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
    const myTransactions = transactions.filter(t => t.senderId === currentUser.id);

    const container = document.getElementById('paymentsList');

    if (myTransactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí≥</div>
                <div class="empty-state-text">Hali to'lovlar yo'q</div>
            </div>
        `;
        return;
    }

    container.innerHTML = myTransactions.map(tx => `
        <div class="transaction-card">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">
                        To'lov: ${tx.receiverName}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        ${formatDate(tx.date)}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem;">
                        Komissiya: ${formatCurrency(tx.commission)}
                    </div>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">
                    -${formatCurrency(tx.amount + tx.commission)}
                </div>
            </div>
        </div>
    `).join('');
}

// History
function loadHistory() {
    const contracts = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTS) || '[]');
    const completedContracts = contracts.filter(c =>
        c.employerId === currentUser.id && c.status === 'completed'
    );

    const container = document.getElementById('historyList');

    if (completedContracts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <div class="empty-state-text">Hali tugallangan ishlar yo'q</div>
            </div>
        `;
        return;
    }

    container.innerHTML = completedContracts.map(contract => `
        <div class="history-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <div>
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">
                        ${contract.jobTitle}
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">
                        üë§ ${contract.workerName}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        Tugallandi: ${formatDate(contract.completedDate)}
                    </div>
                </div>
                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">
                    ${formatCurrency(contract.amount)}
                </div>
            </div>
            ${contract.paid ? `
                <div style="color: var(--success);">‚úÖ To'langan</div>
            ` : `
                <button class="btn-primary" onclick="approvePayment('${contract.id}')">
                    To'lovni tasdiqlash
                </button>
            `}
        </div>
    `).join('');
}
